<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ä¸€è‹±æ–‡æ‰“å­—ç·´ç¿’ (ä½œè€…ï¼šæè€å¸«)</title>
    <style>
        :root {
            --bg-color: #f0f8ff; --highlight-color: #ffd700; --correct-color: #98fb98; --error-color: #ffb6c1;
            --primary-color: #4682b4; --hand-skin: #f3cba6; --finger-highlight: #ff6347;
            --c-l-pinky:#ffb7b2; --c-l-ring:#ffdac1; --c-l-middle:#fff2cc; --c-l-index:#e2f0cb;
            --c-r-index:#b5ead7; --c-r-middle:#c7ceea; --c-r-ring:#e0c3fc; --c-r-pinky:#ffcbf2; --c-func:#e0e0e0;
            --base-key-width: clamp(26px, 4.8vw, 52px); --key-gap: clamp(2px, 0.4vw, 5px);
        }

        body { font-family: "Comic Sans MS", "Microsoft JhengHei", sans-serif; background-color: var(--bg-color); margin: 0; user-select: none; overflow: hidden; height: 100vh; width: 100vw; display: flex; justify-content: center; align-items: center; }
        h1 { color: var(--primary-color); margin: 0 0 1vh 0; font-size: clamp(24px, 4vh, 36px); text-align: center; text-shadow: 2px 2px white;}
        
        .screen-container { display: flex; flex-direction: column; align-items: center; background: white; padding: 2vh 3vw; border-radius: 25px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); width: 90%; max-width: 600px; text-align: center; overflow-y: auto; max-height: 95vh; border: 5px solid #e0f0ff; }
        .input-group { margin: 20px 0; width: 80%; }
        .input-label { display: block; font-size: 20px; color: #555; margin-bottom: 5px; font-weight: bold; }
        .input-field { width: 100%; padding: 12px; font-size: 20px; border: 3px solid #ccc; border-radius: 15px; text-align: center; outline: none; font-family: inherit; box-sizing: border-box; }
        .btn-next { margin-top: 20px; padding: 12px 40px; background: #4682b4; color: white; border: none; border-radius: 50px; font-size: 22px; cursor: pointer; font-weight: bold; box-shadow: 0 5px 0 #2e5a7e; }
        
        #setup-screen, #exam-entry-screen { display: none; }
        .section-box { margin-bottom: 1.5vh; width: 100%; }
        .section-title { font-size: clamp(16px, 2.5vh, 20px); color: #555; margin-bottom: 1vh; font-weight: bold; }
        .option-group { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; }
        .btn-opt { border: 2px solid #ccc; padding: 8px 16px; border-radius: 50px; cursor: pointer; background: white; color: #666; font-family: inherit; }
        .btn-opt.active { background: var(--primary-color); color: white; border-color: var(--primary-color); transform: scale(1.05); }
        .btn-level-opt { width: 48%; margin: 5px 0; padding: 10px; border: 2px solid #ddd; border-radius: 15px; cursor: pointer; background: #f9f9f9; color: #555; }
        .btn-level-opt.active { border-color: var(--primary-color); background: #e6f3ff; box-shadow: 0 0 0 2px var(--primary-color); }
        .btn-start { margin-top: 1vh; padding: 15px 40px; width: 80%; background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%); border: none; border-radius: 50px; font-size: 24px; font-weight: bold; color: white; cursor: pointer; box-shadow: 0 5px 15px rgba(255, 105, 180, 0.4); }
        .btn-exam-start { background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%); box-shadow: 0 5px 15px rgba(255, 0, 0, 0.4); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .btn-leaderboard { margin-top: 15px; background: none; border: 2px solid #ffd700; padding: 8px 20px; border-radius: 20px; cursor: pointer; color: #d4a000; font-weight: bold; }

        #game-screen { display: none; flex-direction: column; align-items: center; justify-content: flex-start; width: 100%; height: 100%; padding-top: 2vh; box-sizing: border-box; }
        .back-btn { position: absolute; top: 10px; left: 10px; z-index: 100; background: #fff; border: 2px solid #ddd; padding: 5px 15px; border-radius: 20px; cursor: pointer; }
        .game-header { display: flex; justify-content: space-between; width: 90%; max-width: 800px; margin-bottom: 1vh; background: white; padding: 10px 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        
        .target-display { font-size: clamp(50px, 12vh, 100px); font-weight: bold; color: var(--primary-color); height: clamp(80px, 18vh, 140px); display: flex; align-items: center; justify-content: center; margin-bottom: 1vh; text-shadow: 2px 2px 0px white; white-space: nowrap; }
        .target-display.bounce { animation: bounce 0.3s ease-in-out; } 
        .target-display.shake { animation: shake 0.4s ease-in-out; color: var(--error-color); }
        .char-done { color: #32cd32; } .char-current { text-decoration: underline; text-decoration-color: #ffd700; text-decoration-thickness: 5px; } .char-todo { color: #ccc; } 
        @keyframes bounce { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }

        .keyboard { background: #dceefc; padding: 2vh 2vw; border-radius: 20px; box-shadow: 0 1vh 0 #b0c4de; margin-bottom: 1vh; position: relative; display: flex; flex-direction: column; align-items: flex-start; width: fit-content; transition: opacity 0.5s; }
        .keyboard.hidden { display: none !important; } 
        .row { display: flex; justify-content: flex-start; margin-bottom: 1vh; gap: var(--key-gap); }
        .row.r1 { margin-left: calc(var(--base-key-width) * 1.5); } .row.r2 { margin-left: 0; } .row.r3 { margin-left: 0; }
        .key { width: var(--base-key-width); height: var(--base-key-width); border-radius: 12%; display: flex; align-items: center; justify-content: center; font-size: calc(var(--base-key-width) * 0.5); font-weight: bold; box-shadow: 0 0.5vh 0 rgba(0,0,0,0.1); color: #444; transition: all 0.1s; border-bottom: 3px solid rgba(0,0,0,0.1); position: relative; z-index: 1; flex-shrink: 0; }
        .key.space { width: calc(var(--base-key-width) * 5); } 
        .key.func { background-color: var(--c-func); font-size: calc(var(--base-key-width) * 0.35); }
        .key.caps { width: calc(var(--base-key-width) * 1.75); } .key.shift-l { width: calc(var(--base-key-width) * 2.25); } .key.shift-r { width: calc(var(--base-key-width) * 2.5); } 
        .k-lp{background:var(--c-l-pinky)} .k-lr{background:var(--c-l-ring)} .k-lm{background:var(--c-l-middle)} .k-li{background:var(--c-l-index)} .k-ri{background:var(--c-r-index)} .k-rm{background:var(--c-r-middle)} .k-rr{background:var(--c-r-ring)} .k-rp{background:var(--c-r-pinky)}
        .key.active { background-color: var(--highlight-color) !important; transform: translateY(0.5vh); border: 2px solid #ff8c00; border-bottom: none; color: black; z-index: 2; }
        .key.caps.on { border: 2px solid #32cd32; box-shadow: 0 0 10px #32cd32; }
        
        #tracer { position: absolute; width: calc(var(--base-key-width) * 0.4); height: calc(var(--base-key-width) * 0.4); background: radial-gradient(circle, #fff 20%, #ffd700 100%); border-radius: 50%; pointer-events: none; opacity: 0; z-index: 1000; box-shadow: 0 0 15px #ffd700; top: 0; left: 0; will-change: transform, opacity; }
        #tracer.animating { animation: trace-move 1.2s infinite ease-out; }
        @keyframes trace-move { 0% { transform: translate(var(--x1), var(--y1)) scale(0.5); opacity: 0.9; } 70% { opacity: 0.9; } 100% { transform: translate(var(--x2), var(--y2)) scale(1.5); opacity: 0; } }
        
        .hands-container { display: flex; justify-content: space-between; width: 90%; max-width: 600px; flex-grow: 1; max-height: 25vh; }
        .hands-container.hidden { display: none !important; }
        .hand { width: 45%; height: 100%; position: relative; }
        svg { width: 100%; height: 100%; } .skin { fill: var(--hand-skin); stroke: #dba378; stroke-width: 2; } .finger { transition: fill 0.2s; } .finger.active { fill: var(--finger-highlight); }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 30px; border-radius: 30px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.3); max-width: 90%; width: 450px; border: 5px solid #4682b4; max-height: 80vh; overflow-y: auto; }
        
        .admin-trigger { position: fixed; bottom: 20px; left: 20px; width: 50px; height: 50px; background: white; border: 2px solid #e0e0e0; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: pointer; z-index: 2000; font-size: 24px; color: #888; transition: all 0.3s ease; display: flex; justify-content: center; align-items: center; }
        .admin-trigger:hover { transform: rotate(90deg) scale(1.1); color: var(--primary-color); border-color: var(--primary-color); box-shadow: 0 4px 15px rgba(70, 130, 180, 0.3); }

        .modal-btn { margin: 5px; padding: 10px 20px; border-radius: 12px; border: none; font-size: 15px; font-weight: 600; cursor: pointer; color: white; transition: all 0.2s ease; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
        .modal-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        .modal-btn:active { transform: translateY(0); }
        
        #result-modal .modal-btn {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            font-size: 32px; /* å­—é«”åŠ å¤§ */
            padding: 20px 60px; /* æŒ‰éˆ•åŠ å¤§ */
            box-shadow: 0 10px 25px rgba(255, 65, 108, 0.5); /* å¼·çƒˆé™°å½± */
            border-radius: 50px;
        }
        #result-modal .modal-btn:hover { transform: scale(1.1); }

        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-success { background: linear-gradient(135deg, #2af598 0%, #009efd 100%); }
        .btn-danger  { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%); color: #d63031; }
        .btn-danger-solid { background: linear-gradient(135deg, #ff5f6d 0%, #ffc371 100%); color: white; }
        .btn-neutral { background: #f0f0f0; color: #666; box-shadow: none; border: 1px solid #ddd;}
        .btn-neutral:hover { background: #e0e0e0; box-shadow: none; }

        .admin-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .tab-btn { background: none; border: none; font-size: 16px; color: #888; padding: 8px 16px; cursor: pointer; font-weight: bold; border-radius: 20px; transition: 0.2s; }
        .tab-btn:hover { background: #f0f0f0; }
        .tab-btn.active { background: #e6f3ff; color: #4682b4; }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .exam-settings-box { border: 2px dashed #ffb6c1; padding: 20px; border-radius: 15px; background: #fffafb; text-align: left; }
        .exam-input { width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 10px; margin-top: 5px; font-family: monospace; font-size: 16px; box-sizing: border-box; }
        .setting-row { margin: 12px 0; display: flex; align-items: center; gap: 10px; font-size: 15px; flex-wrap: wrap; }
        .toggle-label { font-weight: bold; color: #444; cursor: pointer; display: flex; align-items: center; gap: 8px; background: white; padding: 5px 10px; border-radius: 20px; border: 1px solid #eee;}
        input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: #ff6b6b; }

        .admin-filter-bar { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; background: #f8f9fa; padding: 12px; border-radius: 12px; flex-wrap: wrap; border: 1px solid #e0e0e0; }
        .filter-select { padding: 8px; border-radius: 8px; border: 1px solid #ccc; font-size: 14px; outline: none; }
        .filter-select:focus { border-color: #4682b4; }

        .result-score { font-size: clamp(80px, 20vh, 140px); color: #ff4500; font-weight: 900; text-shadow: 5px 5px 0px #ffd700; }
        .lb-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .lb-table th { background: #4682b4; color: white; padding: 10px; position: sticky; top: 0; font-size: 14px;}
        .lb-table td { padding: 10px; border-bottom: 1px solid #eee; font-size: 14px; color: #555; }
    </style>
</head>
<body>

    <button class="admin-trigger" onclick="openAdminLogin()" title="è€å¸«å°ˆç”¨è¨­å®š">âš™ï¸</button>

    <div id="login-screen" class="screen-container">
        <h1>ğŸ‘‹ æ­¡è¿ä¾†åˆ°åŒ–åœ°ç‘ªå°ä¸€åŒå­¸çš„æ‰“å­—ç·´ç¿’</h1>
        <div style="margin-top: 20px; width: 100%;">
            <div class="input-group" style="margin: 0 auto 20px auto;">
                <label class="input-label">å­¸è™Ÿ (Class Number)ï¼š</label>
                <input type="text" id="input-name" class="input-field" placeholder="è«‹è¼¸å…¥å­¸è™Ÿ" autocomplete="off">
            </div>
            <div class="input-group" style="margin: 0 auto 20px auto;">
                <label class="input-label">ç­åˆ¥ (Class)ï¼š</label>
                <input type="text" id="input-class" class="input-field" placeholder="ä¾‹å¦‚: 1A" autocomplete="off">
            </div>
            <button class="btn-next" onclick="enterSetup()">ä¸‹ä¸€æ­¥ â¡ï¸</button>
        </div>
    </div>

    <div id="exam-entry-screen" class="screen-container">
        <h1>ğŸ“ è€ƒè©¦æ¨¡å¼ ğŸ“</h1>
        <div class="section-box">
            <p style="font-size: 20px; color: #555;">è«‹æº–å‚™å¥½ï¼Œè€å¸«å·²ç¶“è¨­å®šå¥½é¡Œç›®äº†ï¼</p>
            <p style="font-size: 16px; color: #888;">æ³¨æ„ï¼šè«‹ä¾ç…§ç•«é¢é¡¯ç¤ºçš„æ–‡å­—é †åºæ‰“å­—ã€‚</p>
        </div>
        <button class="btn-start btn-exam-start" onclick="startExam()">ğŸ“ é–‹å§‹è€ƒè©¦</button>
    </div>

    <div id="setup-screen" class="screen-container">
        <h1>ğŸˆ è¨­å®šç·´ç¿’æ¨¡å¼ ğŸˆ</h1>
        <div class="section-box">
            <div class="section-title">ç¬¬ä¸€æ­¥ï¼šé¸æ“‡å­—æ¯æ¨£å­</div>
            <div class="option-group">
                <button class="btn-opt active" id="opt-mixed" onclick="selectCaseOption('mixed')">å¤§å°çš†å¯</button>
                <button class="btn-opt" id="opt-upper" onclick="selectCaseOption('upper')">åƒ…å¤§å¯«</button>
                <button class="btn-opt" id="opt-lower" onclick="selectCaseOption('lower')">åƒ…å°å¯«</button>
                <button class="btn-opt" id="opt-strict-mixed" onclick="selectCaseOption('strict-mixed')">å¤§å°å¯«æ··åˆåœ°å»æ‰“</button>
            </div>
        </div>
        <div class="section-box">
            <div class="section-title">ç¬¬äºŒæ­¥ï¼šé¸æ“‡ç·´ç¿’ç´šåˆ¥</div>
            <div class="option-group">
                <button class="btn-level-opt active" id="lvl-1" onclick="selectLevel(1)">Level 1 <span class="level-desc">ä¸­é–“æ’</span></button>
                <button class="btn-level-opt" id="lvl-2" onclick="selectLevel(2)">Level 2 <span class="level-desc">ä¸Šæ’</span></button>
                <button class="btn-level-opt" id="lvl-3" onclick="selectLevel(3)">Level 3 <span class="level-desc">ä¸‹æ’</span></button>
                <button class="btn-level-opt" id="lvl-4" onclick="selectLevel(4)">Level 4 <span class="level-desc">å…¨éµç›¤</span></button>
            </div>
        </div>
        <div class="section-box">
            <div class="section-title">ç¬¬ä¸‰æ­¥ï¼šè¨­å®šè¨ˆæ™‚ (ç§’)</div>
            <div class="option-group">
                <button class="btn-opt" id="time-30" onclick="selectTime(30)">30ç§’</button>
                <button class="btn-opt" id="time-60" onclick="selectTime(60)">60ç§’</button>
                <button class="btn-opt active" id="time-90" onclick="selectTime(90)">90ç§’</button>
                <button class="btn-opt" id="time-120" onclick="selectTime(120)">120ç§’</button>
            </div>
        </div>
        <button class="btn-start" onclick="startGame()">ğŸš€ é–‹å§‹éŠæˆ²</button>
        <button class="btn-leaderboard" onclick="showLeaderboard()">ğŸ† æŸ¥çœ‹æ’åæ¦œ</button>
    </div>

    <div id="game-screen">
        <button class="back-btn" onclick="goHome()">ğŸ  çµæŸ</button>
        <div class="game-header">
            <div class="info-box"><span id="player-display"></span><span id="level-indicator" style="color: #555; margin-left: 5px;">Level 1</span></div>
            <div class="info-box"><span class="icon">â±ï¸</span> <span id="timer">90</span><span style="margin-left:15px;" class="icon">â­</span> <span id="score">0</span></div>
        </div>
        <div id="status-msg"></div>
        <div class="target-display" id="target-char">A</div>
        
        <div class="keyboard" id="keyboard-ui">
            <div id="tracer"></div>
            <div class="row r1"><div class="key k-lp" id="key-q">Q</div><div class="key k-lr" id="key-w">W</div><div class="key k-lm" id="key-e">E</div><div class="key k-li" id="key-r">R</div><div class="key k-li" id="key-t">T</div><div class="key k-ri" id="key-y">Y</div><div class="key k-ri" id="key-u">U</div><div class="key k-rm" id="key-i">I</div><div class="key k-rr" id="key-o">O</div><div class="key k-rp" id="key-p">P</div></div>
            <div class="row r2"><div class="key func caps" id="key-capslock">Caps</div><div class="key k-lp" id="key-a">A</div><div class="key k-lr" id="key-s">S</div><div class="key k-lm" id="key-d">D</div><div class="key k-li" id="key-f">F</div><div class="key k-li" id="key-g">G</div><div class="key k-ri" id="key-h">H</div><div class="key k-ri" id="key-j">J</div><div class="key k-rm" id="key-k">K</div><div class="key k-rr" id="key-l">L</div><div class="key k-rp" id="key-semicolon">;</div></div>
            <div class="row r3"><div class="key func shift-l" id="key-shift-l">Shift</div><div class="key k-lp" id="key-z">Z</div><div class="key k-lr" id="key-x">X</div><div class="key k-lm" id="key-c">C</div><div class="key k-li" id="key-v">V</div><div class="key k-li" id="key-b">B</div><div class="key k-ri" id="key-n">N</div><div class="key k-ri" id="key-m">M</div><div class="key func shift-r" id="key-shift-r">Shift</div></div>
            <div class="row r4" style="margin-left: 4u;"><div class="key space" id="key-space"></div></div>
        </div>
        
        <div class="hands-container" id="hands-ui">
            <div class="hand"><svg viewBox="0 0 200 200" preserveAspectRatio="xMidYMax meet"><path id="l-pinky" class="finger skin" d="M20,100 Q15,60 30,50 Q45,60 40,100 L40,140 L20,140 Z" /><path id="l-ring" class="finger skin" d="M50,100 Q45,40 65,30 Q85,40 80,100 L80,140 L50,140 Z" /><path id="l-middle" class="finger skin" d="M90,100 Q85,20 110,15 Q135,20 130,100 L130,140 L90,140 Z" /><path id="l-index" class="finger skin" d="M140,100 Q135,40 155,35 Q175,40 170,100 L170,140 L140,140 Z" /><path id="l-thumb" class="finger skin" d="M180,140 Q200,120 220,130 Q210,160 180,170 Z" transform="translate(-20,0)"/><path class="skin" d="M20,140 L170,140 Q160,190 95,190 Q30,190 20,140 Z" /></svg></div>
            <div class="hand"><svg viewBox="0 0 200 200" preserveAspectRatio="xMidYMax meet"><path id="r-pinky" class="finger skin" d="M180,100 Q185,60 170,50 Q155,60 160,100 L160,140 L180,140 Z" /><path id="r-ring" class="finger skin" d="M150,100 Q155,40 135,30 Q115,40 120,100 L120,140 L150,140 Z" /><path id="r-middle" class="finger skin" d="M110,100 Q115,20 90,15 Q65,20 70,100 L70,140 L110,140 Z" /><path id="r-index" class="finger skin" d="M60,100 Q65,40 45,35 Q25,40 30,100 L30,140 L60,140 Z" /><path id="r-thumb" class="finger skin" d="M20,140 Q0,120 -20,130 Q-10,160 20,170 Z" transform="translate(40,0)"/><path class="skin" d="M180,140 L30,140 Q40,190 105,190 Q170,190 180,140 Z" /></svg></div>
        </div>
    </div>

    <div id="result-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>ğŸ‰ æ™‚é–“åˆ°ï¼ ğŸ‰</h2>
            <div class="result-score" id="final-score">0</div>
            <div><button class="modal-btn btn-retry" onclick="goHome()">ç¢ºå®š</button></div>
        </div>
    </div>

    <div id="leaderboard-modal" class="modal-overlay">
        <div class="modal-content" style="width: 500px;">
            <h2 style="color: #4682b4;">ğŸ† æ’åæ¦œ ğŸ†</h2>
            <div style="max-height: 400px; overflow-y: auto;">
                <table class="lb-table"><thead><tr><th>æ’å</th><th>å§“å</th><th>ç­åˆ¥</th><th>ç´šåˆ¥</th><th>åˆ†æ•¸</th></tr></thead><tbody id="lb-body"></tbody></table>
            </div>
            <button class="modal-btn btn-neutral" onclick="closeModal('leaderboard-modal')" style="width: 100%; margin-top: 15px;">é—œé–‰</button>
        </div>
    </div>

    <div id="admin-login-modal" class="modal-overlay">
        <div class="modal-content" style="width: 300px;">
            <h3>ğŸ”‘ è€å¸«å°ˆç”¨å€</h3>
            <div class="admin-login-box">
                <input type="email" id="admin-email" class="input-field" placeholder="Email" style="font-size: 16px; margin-bottom: 10px;">
                <input type="password" id="admin-pwd" class="input-field" placeholder="å¯†ç¢¼ (Firebase)" style="font-size: 16px;">
                <button class="modal-btn btn-primary" style="width:100%" onclick="verifyAdmin()">ç™»å…¥</button>
                <button class="modal-btn btn-neutral" style="width:100%" onclick="closeModal('admin-login-modal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="admin-panel-modal" class="modal-overlay">
        <div class="modal-content" style="width: 750px; max-width: 95%;">
            <h2 style="color: #4682b4; margin-top:0;">âš™ï¸ å¾Œå°ç®¡ç†</h2>
            
            <div class="admin-tabs">
                <button class="tab-btn active" onclick="switchAdminTab('exam')">ğŸ“ è€ƒè©¦è¨­å®š</button>
                <button class="tab-btn" onclick="switchAdminTab('score')">ğŸ“Š æˆç¸¾ç®¡ç†</button>
            </div>

            <div id="tab-exam" class="tab-content active">
                <div class="exam-settings-box">
                    <label class="toggle-label" style="width: fit-content; margin-bottom: 10px;">
                        <input type="checkbox" id="admin-exam-active"> å•Ÿç”¨è€ƒè©¦æ¨¡å¼ (å­¸ç”Ÿç™»å…¥å¾Œå¼·åˆ¶é€²å…¥)
                    </label>
                    <div class="setting-row">
                        <span>å‡ºé¡Œæ¨¡å¼ï¼š</span>
                        <select id="admin-exam-preset" class="filter-select" onchange="loadExamPreset()">
                            <option value="">-- è«‹é¸æ“‡ --</option>
                            <option value="1">Level 1 (ä¸­é–“æ’ - éš¨æ©Ÿ)</option>
                            <option value="2">Level 2 (ä¸Šæ’ - éš¨æ©Ÿ)</option>
                            <option value="3">Level 3 (ä¸‹æ’ - éš¨æ©Ÿ)</option>
                            <option value="4">Level 4 (å…¨éµç›¤ - éš¨æ©Ÿ)</option>
                            <option value="custom">è‡ªå®šå…§å®¹ (å›ºå®šæ–‡ç« )</option>
                        </select>
                    </div>
                    
                    <div id="admin-casemode-wrapper" class="setting-row">
                        <span>å­—æ¯æ¨£å­ï¼š</span>
                        <select id="admin-exam-casemode" class="filter-select">
                            <option value="mixed">å¤§å°çš†å¯</option>
                            <option value="upper">å¤§å¯«</option>
                            <option value="lower">å°å¯«</option>
                            <option value="strict-mixed">å¤§å°å¯«æ··åˆåœ°å»æ‰“</option>
                        </select>
                    </div>

                    <div id="admin-content-wrapper" style="display:none;">
                        <p style="margin:5px 0; font-size:14px; color:#666;">è€ƒè©¦å…§å®¹ (å–®å­—è«‹ç”¨ç©ºç™½éš”é–‹)ï¼š</p>
                        <textarea id="admin-exam-content" class="exam-input" placeholder="ä¾‹å¦‚: Apple Banana Cat"></textarea>
                    </div>
                    
                    <div class="setting-row">
                        <span>æ™‚é–“ï¼š</span>
                        <select id="admin-exam-time" class="filter-select">
                            <option value="30">30ç§’</option>
                            <option value="60">60ç§’</option>
                            <option value="90">90ç§’</option>
                            <option value="120">120ç§’</option>
                        </select>
                    </div>
                    
                    <div class="setting-row">
                        <label class="toggle-label"><input type="checkbox" id="admin-exam-nohints"> é—œé–‰æç¤º (ç›²æ‰“)</label>
                        <label class="toggle-label" style="margin-left: 15px;"><input type="checkbox" id="admin-exam-nokeyboard"> é—œé–‰éµç›¤</label>
                    </div>
                    <button class="modal-btn btn-primary" style="width:100%; margin-top:10px; font-size: 18px;" onclick="saveExamSettings()">ğŸ’¾ å„²å­˜ä¸¦ç”Ÿæ•ˆ</button>
                </div>
            </div>

            <div id="tab-score" class="tab-content">
                <div class="admin-filter-bar">
                    <span>ğŸ” ç¯©é¸ï¼š</span>
                    <select id="filter-class" class="filter-select" onchange="renderAdminPanel()"><option value="">æ‰€æœ‰ç­åˆ¥</option></select>
                    <select id="filter-level" class="filter-select" onchange="renderAdminPanel()">
                        <option value="">æ‰€æœ‰ç´šåˆ¥</option>
                        <option value="1">Lv.1</option>
                        <option value="2">Lv.2</option>
                        <option value="3">Lv.3</option>
                        <option value="4">Lv.4</option>
                        <option value="Exam">Exam</option>
                    </select>
                    <input type="date" id="filter-date" class="filter-select" onchange="renderAdminPanel()">
                    <button class="modal-btn btn-neutral" style="font-size:12px; padding: 5px 10px;" onclick="resetFilters()">é‡ç½®</button>
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button class="modal-btn btn-success" onclick="exportToExcel()">ğŸ“¥ åŒ¯å‡º Excel</button>
                    <div style="flex-grow: 1;"></div>
                    <button class="modal-btn btn-danger" onclick="deleteSelected()">ğŸ—‘ï¸ åˆªé™¤é¸å–</button>
                    <button class="modal-btn btn-danger-solid" onclick="clearAllData()">âš ï¸ æ¸…ç©ºæ‰€æœ‰</button>
                </div>

                <div style="max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 10px;">
                    <table class="lb-table">
                        <thead><tr><th style="width: 40px;"><input type="checkbox" onchange="toggleAll(this)"></th><th>ç­åˆ¥</th><th>å§“å</th><th>ç´šåˆ¥</th><th>åˆ†æ•¸</th><th>æ—¥æœŸ</th></tr></thead>
                        <tbody id="admin-lb-body"></tbody>
                    </table>
                </div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                <button class="modal-btn btn-danger" onclick="logoutAdmin()">ğŸšª ç™»å‡º</button>
                <button class="modal-btn btn-neutral" onclick="closeModal('admin-panel-modal')">é—œé–‰å¾Œå°</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, getDoc, deleteDoc, query, orderBy, limit, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD-jemerwI_rHJLr2RQqYq69TqBrGuJTow",
            authDomain: "p1typing-b154e.firebaseapp.com",
            projectId: "p1typing-b154e",
            storageBucket: "p1typing-b154e.firebasestorage.app",
            messagingSenderId: "154914471400",
            appId: "1:154914471400:web:754e2b5c1bc300dbb1385d",
            measurementId: "G-XY6SZ4B8KS"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global
        let allRecords = [];
        let examConfig = { isActive: false, content: "", time: 90, noHints: false, noKeyboard: false, caseMode: "mixed", levelMode: "custom" };

        // --- Auth Functions ---
        window.verifyAdmin = async function() {
            const email = document.getElementById('admin-email').value;
            const pwd = document.getElementById('admin-pwd').value;
            if(!email || !pwd) return alert("è«‹è¼¸å…¥ Email å’Œ å¯†ç¢¼");
            
            try {
                await signInWithEmailAndPassword(auth, email, pwd);
                document.getElementById('admin-login-modal').style.display = 'none';
                document.getElementById('admin-pwd').value = '';
                
                await window.refreshAdminData();
                window.loadAdminSettingsUI();
                window.populateClassFilter(); 
                window.renderAdminPanel(); 
                
                document.getElementById('admin-panel-modal').style.display = 'flex';
            } catch (e) {
                alert("ç™»å…¥å¤±æ•—: " + e.message);
            }
        }

        window.logoutAdmin = async function() {
            await signOut(auth);
            document.getElementById('admin-panel-modal').style.display = 'none';
        }

        // --- Firestore Functions ---
        window.saveScoreToFirebase = async function(record) {
            try { await addDoc(collection(db, "scores"), { ...record, timestamp: serverTimestamp() }); } 
            catch (e) { console.error(e); }
        };

        window.fetchLeaderboard = async function() {
            try {
                const q = query(collection(db, "scores"), orderBy("score", "desc"), limit(50));
                const querySnapshot = await getDocs(q);
                let records = [];
                querySnapshot.forEach((doc) => records.push(doc.data()));
                return records;
            } catch (e) { console.error(e); return []; }
        };

        window.fetchAllScores = async function() {
            try {
                const q = query(collection(db, "scores"), orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);
                allRecords = [];
                querySnapshot.forEach((doc) => allRecords.push({ id: doc.id, ...doc.data() }));
                return allRecords;
            } catch (e) { console.error(e); return []; }
        };

        window.deleteScores = async function(ids) {
            try {
                const batch = writeBatch(db);
                ids.forEach(id => { 
                    const ref = doc(db, "scores", String(id)); 
                    batch.delete(ref);
                });
                await batch.commit();
                return true;
            } catch (e) { console.error(e); return false; }
        };

        window.clearAllScores = async function() {
            try {
                const q = query(collection(db, "scores"), limit(500));
                const snapshot = await getDocs(q);
                const batch = writeBatch(db);
                snapshot.forEach((doc) => batch.delete(doc.ref));
                await batch.commit(); return true;
            } catch (e) { console.error(e); return false; }
        };

        window.fetchExamConfig = async function() {
            try {
                const docRef = doc(db, "settings", "examConfig");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) examConfig = docSnap.data();
                else examConfig = { isActive: false, content: "", time: 90, noHints: false, noKeyboard: false, caseMode: "mixed", levelMode: "custom" };
                return examConfig;
            } catch (e) { console.error(e); return { isActive: false }; }
        };

        window.saveExamConfigToFirebase = async function(config) {
            try {
                await setDoc(doc(db, "settings", "examConfig"), config);
                examConfig = config; alert("è€ƒè©¦è¨­å®šå·²å„²å­˜ï¼");
            } catch (e) { console.error(e); alert("å„²å­˜å¤±æ•—"); }
        };

        fetchExamConfig().then(cfg => console.log("Config loaded"));

        window.getExamConfig = () => examConfig;
        window.getAllRecords = () => allRecords;
        window.refreshAdminData = fetchAllScores;
        window.loadAdminSettingsUI = () => {
            const c = examConfig;
            document.getElementById('admin-exam-active').checked = c.isActive||false;
            document.getElementById('admin-exam-content').value = c.content||"";
            document.getElementById('admin-exam-time').value = c.time||"90";
            document.getElementById('admin-exam-nohints').checked = c.noHints||false;
            document.getElementById('admin-exam-nokeyboard').checked = c.noKeyboard||false;
            document.getElementById('admin-exam-casemode').value = c.caseMode || "mixed";
            document.getElementById('admin-exam-preset').value = c.levelMode || "custom";
            window.loadExamPreset(); // åˆå§‹åŒ–é¡¯ç¤ºç‹€æ…‹
        };
    </script>

    <script>
        const levels = { 1:['a','s','d','f','g','h','j','k','l',';'], 2:['q','w','e','r','t','y','u','i','o','p'], 3:['z','x','c','v','b','n','m'], 4:['q','w','e','r','t','y','u','i','o','p','a','s','d','f','g','h','j','k','l',';','z','x','c','v','b','n','m'] };
        const homeRowMap = {'q':'a','w':'s','e':'d','r':'f','t':'f','y':'j','u':'j','i':'k','o':'l','p':';','z':'a','x':'s','c':'d','v':'f','b':'f','n':'j','m':'j','g':'f','h':'j'};
        const fingerMapping = {'l-pinky':['q','a','z'],'l-ring':['w','s','x'],'l-middle':['e','d','c'],'l-index':['r','f','v','t','g','b'],'r-index':['y','h','n','u','j','m'],'r-middle':['i','k'],'r-ring':['o','l'],'r-pinky':['p',';'],'l-thumb':[' '],'r-thumb':[' ']};
        
        // å¢åŠ ï¼šå·¦æ‰‹è² è²¬çš„å­—æ¯é›†åˆ (ç”¨æ–¼åˆ¤æ–·ä½¿ç”¨å“ªå€‹ Shift éµ)
        const leftHandKeysSet = new Set(['q','w','e','r','t','a','s','d','f','g','z','x','c','v','b']);

        let currentUser = { name: '', classVal: '' };
        let selectedCaseMode = 'mixed';
        let selectedLevel = 1;
        let selectedTime = 90;
        let timeLeft = 90;
        let currentTarget = '';
        let score = 0;
        let isGameRunning = false;
        let isCapsLockOn = false; 
        let timerInterval = null;
        
        let isExamMode = false;
        let isRandomExam = false; // æ–°å¢ï¼šæ˜¯å¦ç‚ºéš¨æ©Ÿå‡ºå­—è€ƒè©¦æ¨¡å¼
        let examContentArray = [];
        let examWordIndex = 0;
        let examCharIndex = 0;

        async function enterSetup() {
            const name = document.getElementById('input-name').value.trim();
            const classVal = document.getElementById('input-class').value.trim();
            if (!name || !classVal) { alert("è«‹è¼¸å…¥å§“åå’Œç­åˆ¥å–”ï¼"); return; }
            currentUser.name = name; currentUser.classVal = classVal;
            
            document.getElementById('login-screen').style.display = 'none';
            const config = window.getExamConfig ? window.getExamConfig() : { isActive: false };

            if (config.isActive) {
                document.getElementById('exam-entry-screen').style.display = 'flex';
                isExamMode = true;
            } else {
                document.getElementById('setup-screen').style.display = 'flex';
                isExamMode = false;
            }
        }

        function startExam() {
            const config = window.getExamConfig();
            selectedTime = parseInt(config.time);
            selectedCaseMode = config.caseMode || 'mixed';
            
            // åˆ¤æ–·æ˜¯å¦ç‚ºéš¨æ©Ÿå‡ºé¡Œæ¨¡å¼
            const mode = config.levelMode || 'custom';
            
            if (mode === 'custom') {
                isRandomExam = false;
                let content = config.content || "Apple Banana Cat";
                examContentArray = content.trim().split(/\s+/); 
                if(examContentArray.length === 0) examContentArray = ['Apple'];
                
                // ä¿®æ”¹ï¼šè‡ªå®šæ¨¡å¼ä¸‹ï¼Œä¸é€²è¡Œä»»ä½•é è™•ç†ï¼Œä¿æŒåŸå§‹å¤§å°å¯«
                // ä¸”å¿½ç•¥ selectedCaseMode çš„è¨­å®šï¼Œç›´æ¥ä½¿ç”¨åŸå§‹æ–‡å­—
                
                examWordIndex = 0; examCharIndex = 0;
            } else {
                isRandomExam = true;
                selectedLevel = parseInt(mode); // è¨­å®šç´šåˆ¥ Lv1-Lv4
            }

            const kb = document.getElementById('keyboard-ui');
            const hands = document.getElementById('hands-ui');
            if (config.noKeyboard) { kb.classList.add('hidden'); hands.classList.add('hidden'); } 
            else { kb.classList.remove('hidden'); hands.classList.remove('hidden'); }

            score = 0; timeLeft = selectedTime; isGameRunning = true;
            document.getElementById('result-modal').style.display = 'none';
            document.getElementById('exam-entry-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'flex';
            document.getElementById('level-indicator').innerText = isRandomExam ? "è€ƒè©¦: Lv" + selectedLevel : "è€ƒè©¦æ¨¡å¼";
            document.getElementById('player-display').innerText = `${currentUser.classVal} - ${currentUser.name}`;
            document.getElementById('timer').innerText = timeLeft;
            updateScore();

            if (audioCtx.state === 'suspended') audioCtx.resume();
            checkCapsLockState(new KeyboardEvent('keydown')); 
            nextChar(); 

            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--; document.getElementById('timer').innerText = timeLeft;
                if (timeLeft <= 0) endGame();
            }, 1000);
        }

        function startGame() {
            isExamMode = false;
            isRandomExam = false;
            score = 0; timeLeft = selectedTime; isGameRunning = true;
            document.getElementById('keyboard-ui').classList.remove('hidden');
            document.getElementById('hands-ui').classList.remove('hidden');
            document.getElementById('result-modal').style.display = 'none';
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'flex';
            const titles = {1:"Level 1",2:"Level 2",3:"Level 3",4:"Level 4"};
            document.getElementById('level-indicator').innerText = titles[selectedLevel];
            document.getElementById('player-display').innerText = `${currentUser.classVal} - ${currentUser.name}`;
            document.getElementById('timer').innerText = timeLeft;
            updateScore();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            checkCapsLockState(new KeyboardEvent('keydown')); 
            nextChar();
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--; document.getElementById('timer').innerText = timeLeft;
                if (timeLeft <= 0) endGame();
            }, 1000);
        }

        function endGame() {
            isGameRunning = false; clearInterval(timerInterval);
            const now = new Date();
            const dateStr = now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0')+'-'+String(now.getDate()).padStart(2,'0');
            const record = { name: currentUser.name, class: currentUser.classVal, level: isExamMode ? "Exam" : selectedLevel, score: score, date: now.toLocaleString(), filterDate: dateStr };
            if(window.saveScoreToFirebase) window.saveScoreToFirebase(record);
            document.getElementById('final-score').innerText = score;
            document.getElementById('result-modal').style.display = 'flex';
        }

        function goHome() {
            isGameRunning = false; clearInterval(timerInterval);
            document.getElementById('result-modal').style.display = 'none';
            document.getElementById('game-screen').style.display = 'none';
            if (isExamMode) location.reload(); 
            else document.getElementById('setup-screen').style.display = 'flex';
        }

        function nextChar() {
            if (!isGameRunning) return;
            
            // å¦‚æœæ˜¯è€ƒè©¦æ¨¡å¼ï¼Œä¸”ä¸æ˜¯éš¨æ©Ÿå‡ºå­— (å³è‡ªå®šå…§å®¹æ¨¡å¼)
            if (isExamMode && !isRandomExam) {
                if (examWordIndex >= examContentArray.length) examWordIndex = 0;
                let currentWord = examContentArray[examWordIndex];
                if (examCharIndex >= currentWord.length) {
                    examWordIndex++; examCharIndex = 0;
                    if (examWordIndex >= examContentArray.length) examWordIndex = 0;
                    currentWord = examContentArray[examWordIndex];
                }
                currentTarget = currentWord[examCharIndex];
                updateExamDisplay(currentWord, examCharIndex);
            } else {
                // ç·´ç¿’æ¨¡å¼ OR éš¨æ©Ÿå‡ºå­—çš„è€ƒè©¦æ¨¡å¼
                const chars = levels[selectedLevel];
                let char = chars[Math.floor(Math.random() * chars.length)];
                
                // ä¿®æ”¹ï¼šå¤§å°å¯«é‚è¼¯
                if (selectedCaseMode === 'mixed') {
                    // åŸæœ‰çš„ mixed æ˜¯é¡¯ç¤ºå¤§å¯«ï¼Œä½†å¤§å°å¯«è¼¸å…¥çš†å¯
                    char = char.toLowerCase();
                    currentTarget = char; // é‚è¼¯ä¸Šå­˜å°å¯«ï¼Œä½†é¡¯ç¤ºå¤§å¯«
                } else if (selectedCaseMode === 'strict-mixed') {
                    // æ–°å¢æ¨¡å¼ï¼šéš¨æ©Ÿå¤§å¯«æˆ–å°å¯«
                    const isUpper = Math.random() < 0.5;
                    currentTarget = isUpper ? char.toUpperCase() : char.toLowerCase();
                } else if (selectedCaseMode === 'upper') {
                    char = char.toUpperCase();
                    currentTarget = char;
                } else if (selectedCaseMode === 'lower') {
                    char = char.toLowerCase();
                    currentTarget = char;
                }
                
                const display = document.getElementById('target-char');
                // åŸæœ‰ mixed é¡¯ç¤ºå¤§å¯«
                if (selectedCaseMode === 'mixed') display.innerText = char.toUpperCase();
                else display.innerText = currentTarget;
            }
            const d = document.getElementById('target-char');
            d.classList.remove('bounce', 'shake');
            highlightInterface();
        }

        function updateExamDisplay(word, idx) {
            const display = document.getElementById('target-char');
            let html = "";
            for (let i = 0; i < word.length; i++) {
                if (i < idx) html += `<span class="char-done">${word[i]}</span>`;
                else if (i === idx) html += `<span class="char-current">${word[i]}</span>`;
                else html += `<span class="char-todo">${word[i]}</span>`;
            }
            display.innerHTML = html;
        }

        function highlightInterface() {
            const config = window.getExamConfig ? window.getExamConfig() : {};
            if (isExamMode && (config.noHints || config.noKeyboard)) {
                document.querySelectorAll('.key').forEach(k => k.classList.remove('active'));
                document.querySelectorAll('.finger').forEach(f => f.classList.remove('active'));
                const tracer = document.getElementById('tracer');
                if(tracer) tracer.classList.remove('animating');
                return;
            }

            if (!currentTarget) return;
            const lowerChar = currentTarget.toLowerCase();
            let isUpper = (currentTarget !== lowerChar) && (currentTarget !== ';') && (currentTarget !== ' ');
            
            // åŸæœ‰ mixed é‚è¼¯ï¼šä¸è¦–ç‚ºå¼·åˆ¶å¤§å¯« (é©ç”¨æ–¼ç·´ç¿’æ¨¡å¼ åŠ éš¨æ©Ÿè€ƒè©¦æ¨¡å¼)
            if ((!isExamMode || isRandomExam) && selectedCaseMode === 'mixed') isUpper = false;

            document.querySelectorAll('.key').forEach(k => k.classList.remove('active'));
            document.querySelectorAll('.finger').forEach(f => f.classList.remove('active'));
            const tracer = document.getElementById('tracer');
            tracer.classList.remove('animating');

            let tid = 'key-' + lowerChar; if(lowerChar===';') tid = 'key-semicolon'; if(lowerChar===' ') tid = 'key-space';
            const targetEl = document.getElementById(tid);
            const capsEl = document.getElementById('key-capslock');

            // --- strict-mixed è™•ç†é‚è¼¯ (é›™æ‰‹ Shift åˆ†å·¥) ---
            if (selectedCaseMode === 'strict-mixed' && isUpper) {
                if(targetEl) {
                    targetEl.classList.add('active'); // é«˜äº®å­—æ¯éµ
                    startTracer(lowerChar, targetEl);
                }

                if (leftHandKeysSet.has(lowerChar)) {
                    document.getElementById('key-shift-r').classList.add('active');
                    document.getElementById('r-pinky').classList.add('active');
                } else {
                    document.getElementById('key-shift-l').classList.add('active');
                    document.getElementById('l-pinky').classList.add('active');
                }
                
                highlightFinger(lowerChar);
                return; 
            }
            // --------------------------------------------------

            // åˆ¤æ–·æ˜¯å¦éœ€è¦é«˜äº® (å¦‚æœä¸æ˜¯å¤§å¯«ï¼Œæˆ–è€…æ˜¯åœ¨è‡ªå®šè€ƒè©¦æ¨¡å¼ä¸‹ä¸”è¼¸å…¥æ­£ç¢ºçš„å­—ç¬¦)
            // ä¿®æ”¹é‚è¼¯ï¼šå¦‚æœä¸æ˜¯å¤§å¯«ï¼Œæˆ–è€… (æ˜¯å›ºå®šå…§å®¹è€ƒè©¦ ä¸” ç•¶å‰ç›®æ¨™æ˜¯å°å¯«)
            if(!isUpper || (isExamMode && !isRandomExam && currentTarget === lowerChar)) {
                if(targetEl) { 
                    targetEl.classList.add('active'); 
                    if (lowerChar !== ' ') { startTracer(lowerChar, targetEl); highlightFinger(lowerChar); } 
                    else { document.getElementById('l-thumb').classList.add('active'); document.getElementById('r-thumb').classList.add('active'); }
                }
                return;
            }

            if(isUpper) {
                if(isCapsLockOn) { if(targetEl) { targetEl.classList.add('active'); startTracer(lowerChar, targetEl); highlightFinger(lowerChar); } } 
                else { if(capsEl) { capsEl.classList.add('active'); document.getElementById('l-pinky').classList.add('active'); startTracer('capslock', capsEl); } }
                return;
            }
        }

        function startTracer(char, el) {
            const config = window.getExamConfig ? window.getExamConfig() : {};
            if (isExamMode && (config.noHints || config.noKeyboard)) return;
            const tracer = document.getElementById('tracer');
            if(!tracer) return;

            let homeChar = homeRowMap[char]; if(char==='capslock') homeChar='a'; if(!homeChar || homeChar===char) return;
            let hid = 'key-'+homeChar; if(homeChar===';') hid='key-semicolon';
            const home = document.getElementById(hid);
            const kb = document.getElementById('keyboard-ui');

            if(home && el && kb) {
                const kRect = kb.getBoundingClientRect();
                const hRect = home.getBoundingClientRect();
                const tRect = el.getBoundingClientRect();
                const r = tracer.offsetWidth/2;

                const x1 = hRect.left - kRect.left + hRect.width/2 - r;
                const y1 = hRect.top - kRect.top + hRect.height/2 - r;
                const x2 = tRect.left - kRect.left + tRect.width/2 - r;
                const y2 = tRect.top - kRect.top + tRect.height/2 - r;

                tracer.style.setProperty('--x1', `${x1}px`);
                tracer.style.setProperty('--y1', `${y1}px`);
                tracer.style.setProperty('--x2', `${x2}px`);
                tracer.style.setProperty('--y2', `${y2}px`);
                
                void tracer.offsetWidth; 
                tracer.classList.add('animating');
            }
        }

        async function showLeaderboard() {
            const tbody = document.getElementById('lb-body'); tbody.innerHTML = '<tr><td colspan="5">è¼‰å…¥ä¸­...</td></tr>';
            document.getElementById('leaderboard-modal').style.display = 'flex';
            if(window.fetchLeaderboard) {
                const records = await window.fetchLeaderboard();
                tbody.innerHTML = '';
                if(records.length === 0) tbody.innerHTML = '<tr><td colspan="5">æš«ç„¡ç´€éŒ„</td></tr>';
                else {
                    records.forEach((rec, index) => {
                        let rankHTML = index+1; if(index==0) rankHTML='ğŸ¥‡'; else if(index==1) rankHTML='ğŸ¥ˆ'; else if(index==2) rankHTML='ğŸ¥‰';
                        tbody.innerHTML += `<tr><td>${rankHTML}</td><td>${rec.name}</td><td>${rec.class}</td><td>${rec.level==='Exam'?'ğŸ“':('Lv.'+rec.level)}</td><td style="font-weight:bold;">${rec.score}</td></tr>`;
                    });
                }
            }
        }

        function openAdminLogin() { document.getElementById('admin-login-modal').style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        function populateClassFilter() {
            const records = window.getAllRecords(); 
            const classes = [...new Set(records.map(r => r.class))].sort();
            const select = document.getElementById('filter-class'); 
            select.innerHTML = '<option value="">æ‰€æœ‰ç­åˆ¥</option>';
            classes.forEach(c => { select.innerHTML += `<option value="${c}">${c}</option>`; });
        }

        function renderAdminPanel() {
            const tbody = document.getElementById('admin-lb-body'); 
            tbody.innerHTML = '';
            let records = window.getAllRecords(); 
            
            const fClass = document.getElementById('filter-class').value;
            const fLevel = document.getElementById('filter-level').value;
            const fDate = document.getElementById('filter-date').value;

            records = records.filter(rec => {
                if (fClass && rec.class !== fClass) return false;
                if (fLevel && String(rec.level) !== String(fLevel)) return false;
                if (fDate && rec.filterDate !== fDate) return false;
                return true;
            });

            // ä¿®æ”¹æ’åºé‚è¼¯ï¼šæŒ‰åˆ†æ•¸å¾é«˜åˆ°ä½æ’
            records.sort((a, b) => (b.score || 0) - (a.score || 0));

            if(records.length===0) tbody.innerHTML = '<tr><td colspan="6">ç„¡è³‡æ–™</td></tr>';
            else {
                records.forEach(rec => {
                    tbody.innerHTML += `<tr><td><input type="checkbox" class="del-chk" data-id="${rec.id}"></td><td>${rec.class}</td><td>${rec.name}</td><td>${rec.level}</td><td>${rec.score}</td><td style="font-size:12px;">${rec.date}</td></tr>`; 
                });
            }
        }

        function resetFilters() { document.getElementById('filter-class').value=""; document.getElementById('filter-level').value=""; document.getElementById('filter-date').value=""; renderAdminPanel(); }
        function toggleAll(source) { document.querySelectorAll('.del-chk').forEach(cb => cb.checked = source.checked); }
        async function deleteSelected() {
            if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
            const checks = document.querySelectorAll('.del-chk:checked');
            const ids = Array.from(checks).map(cb => cb.dataset.id);
            if(ids.length > 0 && window.deleteScores) { 
                await window.deleteScores(ids); 
                await window.refreshAdminData(); 
                renderAdminPanel(); 
            }
        }
        async function clearAllData() { 
            if(confirm("ç¢ºå®šæ¸…ç©ºï¼Ÿ") && window.clearAllScores) { 
                await window.clearAllScores(); 
                await window.refreshAdminData(); 
                renderAdminPanel(); 
            } 
        }
        function exportToExcel() {
            let records = window.getAllRecords(); 
            const fClass = document.getElementById('filter-class').value;
            const fLevel = document.getElementById('filter-level').value;
            const fDate = document.getElementById('filter-date').value;
            records = records.filter(rec => {
                if (fClass && rec.class !== fClass) return false;
                if (fLevel && String(rec.level) !== String(fLevel)) return false;
                if (fDate && rec.filterDate !== fDate) return false;
                return true;
            });

            if(records.length===0) return alert("ç„¡è³‡æ–™");
            let csv = "\uFEFFç­åˆ¥,å§“å,ç´šåˆ¥,åˆ†æ•¸,æ—¥æœŸ\n"; 
            records.forEach(r => csv += `${r.class},${r.name},${r.level},${r.score},${r.date}\n`);
            const link = document.createElement("a"); 
            link.href = URL.createObjectURL(new Blob([csv], {type:'text/csv;charset=utf-8;'}));
            link.download = "æˆç¸¾.csv"; link.click();
        }

        // ä¿®æ”¹ï¼šloadExamPreset ç¾åœ¨è² è²¬æ§åˆ¶è¼¸å…¥æ¡† å’Œ å­—æ¯æ¨£å­é¸æ“‡ çš„é¡¯ç¤º/éš±è—
        function loadExamPreset() {
            const lvl = document.getElementById('admin-exam-preset').value; 
            const contentWrapper = document.getElementById('admin-content-wrapper');
            const caseWrapper = document.getElementById('admin-casemode-wrapper');
            
            if (lvl === 'custom') {
                contentWrapper.style.display = 'block'; // é¡¯ç¤ºè¼¸å…¥æ¡†
                caseWrapper.style.display = 'none'; // éš±è—å­—æ¯æ¨£å­ (å¼·åˆ¶åŸå§‹)
            } else {
                contentWrapper.style.display = 'none'; // éš±è—è¼¸å…¥æ¡†
                caseWrapper.style.display = 'flex'; // é¡¯ç¤ºå­—æ¯æ¨£å­
            }
        }

        function saveExamSettings() {
            const config = {
                isActive: document.getElementById('admin-exam-active').checked,
                content: document.getElementById('admin-exam-content').value,
                time: document.getElementById('admin-exam-time').value,
                noHints: document.getElementById('admin-exam-nohints').checked,
                noKeyboard: document.getElementById('admin-exam-nokeyboard').checked,
                caseMode: document.getElementById('admin-exam-casemode').value,
                levelMode: document.getElementById('admin-exam-preset').value // å„²å­˜é¸æ“‡çš„å‡ºé¡Œæ¨¡å¼ (Lv1-4 or Custom)
            };
            if(window.saveExamConfigToFirebase) window.saveExamConfigToFirebase(config);
        }
        function switchAdminTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            if(tab === 'exam') {
                document.querySelector('button[onclick="switchAdminTab(\'exam\')"]').classList.add('active');
                document.getElementById('tab-exam').classList.add('active');
            } else {
                document.querySelector('button[onclick="switchAdminTab(\'score\')"]').classList.add('active');
                document.getElementById('tab-score').classList.add('active');
            }
        }

        function selectCaseOption(m) { 
            selectedCaseMode = m; 
            ['mixed','upper','lower','strict-mixed'].forEach(id=>document.getElementById('opt-'+id).classList.remove('active')); 
            document.getElementById('opt-'+m).classList.add('active'); 
        }
        function selectLevel(l) { selectedLevel = l; [1,2,3,4].forEach(i=>document.getElementById('lvl-'+i).classList.remove('active')); document.getElementById('lvl-'+l).classList.add('active'); }
        function selectTime(t) { selectedTime = t; [30,60,90,120].forEach(i=>document.getElementById('time-'+i).classList.remove('active')); document.getElementById('time-'+t).classList.add('active'); }
        function highlightFinger(char) {
            const config = window.getExamConfig ? window.getExamConfig() : {};
            if (isExamMode && config.noHints) return;
            let fid = null; for(const [id, keys] of Object.entries(fingerMapping)) { if(keys.includes(char)) { fid=id; break; } }
            if(fid) document.getElementById(fid).classList.add('active');
        }
        function updateScore() { document.getElementById('score').innerText = score; }
        window.addEventListener('resize', () => { if(isGameRunning) highlightInterface(); });
        document.addEventListener('click', (e) => checkCapsLockState(e));
        document.addEventListener('keyup', (e) => checkCapsLockState(e));
        
        document.addEventListener('keydown', (e) => {
            checkCapsLockState(e);
            if (!isGameRunning) return;
            if (e.ctrlKey || e.altKey || e.metaKey) return;
            if (e.key === 'Shift' || e.key === 'CapsLock') { highlightInterface(); return; }
            
            const input = e.key;
            let isCorrect = false;
            
            // é‚è¼¯ä¿®æ­£ï¼šå¦‚æœæ˜¯ã€Œè‡ªå®šå…§å®¹è€ƒè©¦ã€æ¨¡å¼ï¼Œå¼·åˆ¶ä½¿ç”¨åš´æ ¼æ¯”å° (å®Œå…¨ä¸çœ‹ selectedCaseMode)
            if (isExamMode && !isRandomExam) {
                if (input === currentTarget) isCorrect = true;
            } else {
                // ç·´ç¿’æ¨¡å¼ OR éš¨æ©Ÿè€ƒè©¦æ¨¡å¼
                if (selectedCaseMode === 'mixed') { 
                    if (input.toLowerCase() === currentTarget.toLowerCase()) isCorrect = true; 
                } else if (selectedCaseMode === 'strict-mixed') {
                    if (input === currentTarget) isCorrect = true;
                } else { 
                    if (input === currentTarget) isCorrect = true; 
                }
            }

            if(isCorrect) {
                playSuccessSound(); score+=10; updateScore();
                // å¦‚æœæ˜¯è‡ªå®šå…§å®¹è€ƒè©¦ï¼Œä½¿ç”¨ char-currentï¼›å¦‚æœæ˜¯éš¨æ©Ÿè€ƒè©¦ï¼Œä½¿ç”¨ target-char
                const bounceEl = (isExamMode && !isRandomExam) ? document.querySelector('.char-current') : document.getElementById('target-char');
                if(bounceEl) bounceEl.style.color = '#32cd32'; 
                
                if (isExamMode && !isRandomExam) { 
                    examCharIndex++; nextChar(); 
                } else { 
                    document.getElementById('target-char').classList.add('bounce'); setTimeout(nextChar, 200); 
                }
            } else {
                const shakeEl = (isExamMode && !isRandomExam) ? document.querySelector('.target-display') : document.getElementById('target-char');
                shakeEl.classList.remove('shake'); void shakeEl.offsetWidth; shakeEl.classList.add('shake');
            }
        });

        function checkCapsLockState(e) { if(e && typeof e.getModifierState==='function') isCapsLockOn = e.getModifierState("CapsLock"); const k=document.getElementById('key-capslock'); if(isCapsLockOn){k.classList.add('on');document.getElementById('status-msg').innerText="Caps Lock é–‹å•Ÿä¸­";}else{k.classList.remove('on');document.getElementById('status-msg').innerText="";} if(isGameRunning) highlightInterface(); }
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSuccessSound() { if(audioCtx.state==='suspended') audioCtx.resume(); const o=audioCtx.createOscillator();const g=audioCtx.createGain();o.frequency.setValueAtTime(500,audioCtx.currentTime);o.frequency.exponentialRampToValueAtTime(1000,audioCtx.currentTime+0.1);g.gain.setValueAtTime(0.1,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.1);o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+0.1); }
    </script>
</body>
</html>
